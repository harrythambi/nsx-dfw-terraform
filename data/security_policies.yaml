# =============================================================================
# NSX-T Security Policies Configuration
# =============================================================================
# Defines firewall RULES that control traffic flow.
#
# RULE FIELDS:
#   source_groups:         Source group names (omit for ANY)
#   sources_excluded:      true = NOT these sources (negate)
#   destination_groups:    Destination group names (omit for ANY)
#   destinations_excluded: true = NOT these destinations (negate)
#   services:              Service names (omit for ANY)
#   action:                ALLOW, DROP, or REJECT
#   logged:                Enable logging
#   direction:             IN_OUT (default), IN, or OUT
#
# CATEGORIES (evaluation order):
#   Emergency, Infrastructure, Environment, Application
#
# RESOURCE TAGS:
#   tags: [{scope: "key", tag: "value"}]  - Tags ON the policy/rule itself
# =============================================================================

security_policies:
  # ---------------------------------------------------------------------------
  # VM Groups Policy
  # ---------------------------------------------------------------------------
  - name: test-vm-groups-policy
    display_name: "Test VM Groups Policy"
    description: "Test policy for VM-based security groups"
    category: Application
    tags:
      - scope: managed-by
        tag: terraform
    rules:
      - display_name: "Allow NAS to Management"
        action: ALLOW
        source_groups:
          - vm-group-nas
        destination_groups:
          - vm-group-management
        logged: true

      - display_name: "Allow vCenter Outbound"
        action: ALLOW
        source_groups:
          - vm-group-vcenter
        # destination_groups omitted = ANY

      - display_name: "Allow NSX Infrastructure"
        action: ALLOW
        source_groups:
          - vm-group-nsx
        destination_groups:
          - vm-group-nsx

  # ---------------------------------------------------------------------------
  # Segment Groups Policy
  # ---------------------------------------------------------------------------
  - name: test-segment-groups-policy
    display_name: "Test Segment Groups Policy"
    description: "Test policy for segment-based security groups"
    category: Application
    rules:
      - display_name: "Allow Tenant01 Internal"
        action: ALLOW
        source_groups:
          - segment-group-tenant01
        destination_groups:
          - segment-group-tenant01
        logged: true

      - display_name: "Allow Tenant02 Internal"
        action: ALLOW
        source_groups:
          - segment-group-tenant02
        destination_groups:
          - segment-group-tenant02

      - display_name: "Allow Holodeck Internal"
        action: ALLOW
        source_groups:
          - segment-group-holodeck
        destination_groups:
          - segment-group-holodeck

      - display_name: "Allow Infra Segments"
        action: ALLOW
        source_groups:
          - segment-group-infra
        destination_groups:
          - segment-group-infra

  # ---------------------------------------------------------------------------
  # Nested Groups Policy
  # ---------------------------------------------------------------------------
  - name: test-nested-groups-policy
    display_name: "Test Nested Groups Policy"
    description: "Test policy for nested security groups"
    category: Application
    rules:
      - display_name: "Allow All VMs Nested Group"
        action: ALLOW
        source_groups:
          - nested-group-all-vms
        logged: true

      - display_name: "Allow All Segments Nested Group"
        action: ALLOW
        source_groups:
          - nested-group-all-segments
        destination_groups:
          - nested-group-all-segments

  # ---------------------------------------------------------------------------
  # Mixed Groups Policy
  # ---------------------------------------------------------------------------
  - name: test-mixed-groups-policy
    display_name: "Test Mixed Groups Policy"
    description: "Test policy for mixed member groups"
    category: Application
    rules:
      - display_name: "Allow AVI Infrastructure"
        action: ALLOW
        source_groups:
          - mixed-group-avi
        destination_groups:
          - mixed-group-avi
        logged: true

      - display_name: "Allow Complete Mixed Group"
        action: ALLOW
        source_groups:
          - mixed-group-complete

  # ---------------------------------------------------------------------------
  # Hybrid Groups Policy
  # ---------------------------------------------------------------------------
  - name: test-hybrid-groups-policy
    display_name: "Test Hybrid Groups Policy"
    description: "Test policy for hybrid dynamic and static groups"
    category: Application
    rules:
      - display_name: "Allow Hybrid Group Traffic"
        action: ALLOW
        source_groups:
          - hybrid-group-tagged-plus-static
        destination_groups:
          - vm-group-management
        logged: true

  # ---------------------------------------------------------------------------
  # IP Groups Policy
  # ---------------------------------------------------------------------------
  - name: test-ip-groups-policy
    display_name: "Test IP Groups Policy"
    description: "Test policy for IP-based groups"
    category: Application
    rules:
      - display_name: "Allow Management Networks"
        action: ALLOW
        source_groups:
          - ip-group-management
        logged: true

  # ---------------------------------------------------------------------------
  # All VMs Policy
  # ---------------------------------------------------------------------------
  - name: test-all-vms-policy
    display_name: "Test All VMs Policy"
    description: "Test policy for all VMs group"
    category: Application
    rules:
      - display_name: "Allow All Lab VMs"
        action: ALLOW
        source_groups:
          - all-lab-vms
        destination_groups:
          - all-lab-vms
        services:
          - web-services
          - icmp-ping
        logged: true

  # ---------------------------------------------------------------------------
  # Cross-Group Policy
  # ---------------------------------------------------------------------------
  - name: test-cross-group-policy
    display_name: "Test Cross Group Policy"
    description: "Test communication between different group types"
    category: Application
    rules:
      - display_name: "Allow VMs to Segments"
        action: ALLOW
        source_groups:
          - vm-group-management
        destination_groups:
          - segment-group-tenant01
        services:
          - database-services

      - display_name: "Allow Nested to Mixed"
        action: ALLOW
        source_groups:
          - nested-group-all-vms
        destination_groups:
          - mixed-group-complete

  # ---------------------------------------------------------------------------
  # Negate/Exclude Examples
  # ---------------------------------------------------------------------------
  - name: test-negate-policy
    display_name: "Test Negate Policy"
    description: "Test policy demonstrating source/destination exclusion"
    category: Application
    rules:
      # Block traffic FROM everywhere EXCEPT management networks
      - display_name: "Block Non-Management Sources"
        action: DROP
        source_groups:
          - ip-group-management
        sources_excluded: true        # NOT from management = block untrusted
        destination_groups:
          - vm-group-nsx
        logged: true

      # Allow traffic TO everywhere EXCEPT restricted destinations
      - display_name: "Allow Except Restricted"
        action: ALLOW
        source_groups:
          - vm-group-management
        destination_groups:
          - segment-group-holodeck
        destinations_excluded: true   # NOT to holodeck = allow to everywhere else

      # Block traffic both ways using negate
      - display_name: "Complex Exclusion Rule"
        action: DROP
        source_groups:
          - vm-group-nas
        sources_excluded: true        # NOT from NAS
        destination_groups:
          - vm-group-nsx
        destinations_excluded: true   # NOT to NSX
        logged: true
